# ===================================
# VPS向けPostgreSQL設定ファイル
# メモリ使用量を最小限に抑えた設定
# ===================================

# ===================================
# 基本設定
# ===================================
listen_addresses = '*'
port = 5432
max_connections = 20                    # 接続数を制限（デフォルト100→20）

# ===================================
# メモリ設定（VPS最適化）
# ===================================
shared_buffers = 32MB                  # 共有バッファ（デフォルト128MB→32MB）
effective_cache_size = 128MB           # OS側キャッシュサイズ（デフォルト4GB→128MB）
work_mem = 2MB                         # ソート等作業用メモリ（デフォルト4MB→2MB）
maintenance_work_mem = 16MB            # VACUUM等メンテナンス用（デフォルト64MB→16MB）

# ===================================
# WAL（Write-Ahead Logging）設定
# ===================================
wal_buffers = 1MB                      # WALバッファサイズ（デフォルト-1→1MB）
checkpoint_completion_target = 0.9     # チェックポイント完了目標
wal_writer_delay = 200ms               # WALライター遅延

# ===================================
# プランナー設定
# ===================================
random_page_cost = 1.1                 # SSD向け設定（HDDは4.0）
effective_io_concurrency = 200         # SSD向け並行I/O設定

# ===================================
# ログ設定
# ===================================
log_destination = 'stderr'
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%a.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# パフォーマンス分析用ログ（必要に応じて有効化）
log_min_duration_statement = 1000      # 1秒以上のクエリをログ出力
log_statement = 'mod'                  # INSERT/UPDATE/DELETE等をログ出力

# ===================================
# 自動バキューム設定（軽量化）
# ===================================
autovacuum = on
autovacuum_max_workers = 2             # ワーカー数削減（デフォルト3→2）
autovacuum_work_mem = 8MB              # バキューム用メモリ削減

# ===================================
# セキュリティ設定
# ===================================
ssl = off                              # 必要に応じてon（証明書設定要）
password_encryption = scram-sha-256    # パスワード暗号化強化

# ===================================
# その他最適化設定
# ===================================
fsync = on                             # データ安全性確保
synchronous_commit = on                # 同期コミット（安全性重視）
full_page_writes = on                  # フルページ書き込み（安全性重視）

# タイムゾーン設定
timezone = 'Asia/Tokyo'
log_timezone = 'Asia/Tokyo'

# ロケール設定
lc_messages = 'en_US.UTF-8'
lc_monetary = 'ja_JP.UTF-8'
lc_numeric = 'ja_JP.UTF-8'
lc_time = 'ja_JP.UTF-8'
